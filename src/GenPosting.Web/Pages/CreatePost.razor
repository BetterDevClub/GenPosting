@page "/create"
@using GenPosting.Shared.DTOs
@using GenPosting.Web.Services
@using GenPosting.Web.Components
@inject HttpClient Http
@inject NavigationManager Nav
@inject ILinkedInStateService LinkedInState
@inject IInstagramStateService InstagramState
@inject ISnackbar Snackbar

<PageTitle>Create Post - GenPosting</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudGrid>
        <!-- LEFT COLUMN: Account Selection -->
        <MudItem xs="12" md="3">
            <MudPaper Class="pa-4 h-100" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-4">Select Accounts</MudText>
                
                @if (_loadingProfiles)
                {
                    <MudProgressCircular Indeterminate="true" Size="Size.Small" />
                }
                else
                {
                    <!-- LinkedIn Account -->
                    <div class="d-flex align-center mb-3 pa-2 rounded @(_linkedInSelected ? "mud-theme-primary-hover" : "")" 
                         style="border: 1px solid #e0e0e0; cursor: pointer;" 
                         @onclick="@(() => ToggleLinkedIn(null))">
                        <MudCheckBox T="bool" Value="@_linkedInSelected" ValueChanged="@OnLinkedInChanged" Color="Color.Primary" Dense="true" StopClickPropagation="true" />
                        <div class="d-flex align-center gap-2 flex-grow-1">
                            @if (LinkedInState.IsAuthenticated)
                            {
                                @if (_linkedInProfile != null)
                                {
                                    <MudAvatar Size="Size.Medium">
                                        @if (!string.IsNullOrEmpty(_linkedInProfile.PictureUrl))
                                        {
                                            <MudImage Src="@_linkedInProfile.PictureUrl" />
                                        }
                                        else
                                        {
                                            @_linkedInProfile.Name.FirstOrDefault()
                                        }
                                    </MudAvatar>
                                    <div>
                                        <MudText Typo="Typo.body2" Style="font-weight: 600;">@_linkedInProfile.Name</MudText>
                                        <MudText Typo="Typo.caption">LinkedIn</MudText>
                                    </div>
                                }
                                else if (_loadingProfiles)
                                {
                                    <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                    <MudText Typo="Typo.body2">LinkedIn (Loading...)</MudText>
                                }
                                else
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.Error" Color="Color.Error" />
                                    <MudText Typo="Typo.body2" Color="Color.Error">Load Failed</MudText>
                                }
                            }
                            else
                            {
                                <MudIcon Icon="@Icons.Custom.Brands.LinkedIn" Color="Color.Default" />
                                <MudText Typo="Typo.body2">LinkedIn (Not Connected)</MudText>
                            }
                        </div>
                    </div>

                    <!-- Instagram Account -->
                    <div class="d-flex align-center pa-2 rounded @(_instagramSelected ? "mud-theme-secondary-hover" : "")" 
                         style="border: 1px solid #e0e0e0; cursor: pointer;"
                         @onclick="@(() => ToggleInstagram(null))">
                        <MudCheckBox T="bool" Value="@_instagramSelected" ValueChanged="@OnInstagramChanged" Color="Color.Secondary" Dense="true" StopClickPropagation="true"/>
                        <div class="d-flex align-center gap-2 flex-grow-1">
                            @if (InstagramState.IsAuthenticated)
                            {
                                @if (_instagramProfile != null)
                                {
                                    <MudAvatar Size="Size.Medium">
                                        @(_instagramProfile.Username.FirstOrDefault())
                                    </MudAvatar>
                                    <div>
                                        <MudText Typo="Typo.body2" Style="font-weight: 600;">@_instagramProfile.Username</MudText>
                                        <MudText Typo="Typo.caption">Instagram</MudText>
                                    </div>
                                }
                                else if (_loadingProfiles)
                                {
                                    <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                    <MudText Typo="Typo.body2">Instagram (Loading...)</MudText>
                                }
                                else
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.Error" Color="Color.Error" />
                                    <MudText Typo="Typo.body2" Color="Color.Error">Load Failed</MudText>
                                }
                            }
                            else
                            {
                                <MudIcon Icon="@Icons.Custom.Brands.Instagram" Color="Color.Default" />
                                <MudText Typo="Typo.body2">Instagram (Not Connected)</MudText>
                            }
                        </div>
                    </div>
                }
            </MudPaper>
        </MudItem>

        <!-- MIDDLE COLUMN: Editor -->
        <MudItem xs="12" md="5">
            <MudPaper Class="pa-4 h-100" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-4">Compose</MudText>
                
                <MudTextField T="string" Label="What do you want to share?" Variant="Variant.Outlined" Lines="6" 
                              @bind-Value="_postContent" Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.EmojiEmotions" 
                              Class="mb-4" HelperText="You can use hashtags and mentions" />

                <!-- Media Upload -->
                <div class="d-flex align-center gap-2 mb-4">
                     <MudFileUpload T="IReadOnlyList<IBrowserFile>" FilesChanged="UploadFiles" Accept=".png, .jpg, .jpeg, .mp4">
                        <ActivatorContent>
                            <MudButton Variant="Variant.Outlined"
                                       Color="Color.Primary"
                                       StartIcon="@Icons.Material.Filled.CloudUpload">
                                Add Media
                            </MudButton>
                        </ActivatorContent>
                    </MudFileUpload>
                    <MudText Typo="Typo.caption">Supported: JPG, PNG, MP4</MudText>
                </div>

                @if (_uploadedFiles.Any())
                {
                    <div class="d-flex gap-2 flex-wrap mb-4">
                        @foreach (var file in _uploadedFiles)
                        {
                            <MudChip T="string" OnClose="@(() => RemoveFile(file))" Color="Color.Primary" Variant="Variant.Text">
                                @(file.Name.Length > 20 ? file.Name.Substring(0, 17) + "..." : file.Name)
                            </MudChip>
                        }
                    </div>
                }

                <MudDivider Class="my-4" />

                <!-- Follow-up Comments -->
                <MudExpansionPanels Elevation="0" Class="mb-4">
                    <MudExpansionPanel Text="Follow-up Comments" Icon="@Icons.Material.Filled.Comment">
                         <div class="d-flex gap-2">
                            <MudTextField @bind-Value="_newComment" Label="Type a comment..." Variant="Variant.Outlined" Margin="Margin.Dense" />
                            <MudIconButton Icon="@Icons.Material.Filled.Add" Color="Color.Primary" OnClick="AddComment" />
                        </div>
                        
                        @if (_comments.Any())
                        {
                            <MudList T="string" Dense="true" Class="mt-2">
                                @foreach (var comment in _comments)
                                {
                                    <MudListItem>
                                        <div class="d-flex justify-space-between align-center">
                                            <MudText Typo="Typo.body2">@comment</MudText>
                                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(() => _comments.Remove(comment))" />
                                        </div>
                                    </MudListItem>
                                }
                            </MudList>
                        }
                    </MudExpansionPanel>
                </MudExpansionPanels>

                <!-- Scheduling -->
                <div class="d-flex align-center gap-2 mb-6">
                    <MudSwitch @bind-Value="_isScheduled" Color="Color.Primary" Label="Schedule for later" />
                </div>

                @if (_isScheduled)
                {
                    <div class="d-flex gap-4 mb-6">
                        <MudDatePicker Label="Date" @bind-Date="_scheduledDate" MinDate="DateTime.Today" />
                        <MudTimePicker Label="Time" @bind-Time="_scheduledTime" />
                    </div>
                }

                <!-- Action Buttons -->
                <div class="d-flex justify-end gap-2">
                     <MudButton Variant="Variant.Text" Color="Color.Error">Clear</MudButton>
                     <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SubmitPost" Disabled="@(_isPosting || (!_linkedInSelected && !_instagramSelected) || string.IsNullOrWhiteSpace(_postContent))">
                        @if (_isPosting)
                        {
                            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true"/>
                            <MudText Class="ms-2">Processing</MudText>
                        }
                        else
                        {
                            @(_isScheduled ? "Schedule Post" : "Post Now")
                        }
                    </MudButton>
                </div>

            </MudPaper>
        </MudItem>

        <!-- RIGHT COLUMN: Preview -->
        <MudItem xs="12" md="4">
            <MudPaper Class="pa-4 h-100" Elevation="2" Style="background-color: #f5f5f5;">
                <MudText Typo="Typo.h6" Class="mb-2">Preview</MudText>
                
                <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-2">
                    <MudTabPanel Text="LinkedIn" Icon="@Icons.Custom.Brands.LinkedIn" Disabled="@(!_linkedInSelected)">
                         <LinkedInPostPreview 
                            AuthorName="@(_linkedInProfile?.Name ?? "Your Name")"
                            AuthorAvatarUrl="@(_linkedInProfile?.PictureUrl)"
                            Content="@_postContent"
                            Images="@_previewImages"
                            VideoUrl="@_previewVideoUrl"
                         />
                    </MudTabPanel>
                    <MudTabPanel Text="Instagram" Icon="@Icons.Custom.Brands.Instagram" Disabled="@(!_instagramSelected)">
                        <InstagramPostPreview 
                            AuthorName="@(_instagramProfile?.Username ?? "username")"
                            AuthorAvatarUrl="" 
                            Content="@_postContent"
                            Images="@_previewImages"
                            VideoUrl="@_previewVideoUrl"
                            Comments="@_comments"
                        />
                    </MudTabPanel>
                </MudTabs>
                
                @if (!_linkedInSelected && !_instagramSelected)
                {
                    <MudAlert Severity="Severity.Info" Class="mt-4">Select a platform to see the preview.</MudAlert>
                }
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private bool _loadingProfiles = true;
    private LinkedInProfileDto? _linkedInProfile;
    private InstagramUserDto? _instagramProfile;
    
    // Selection State
    private bool _linkedInSelected;
    private bool _instagramSelected;

    // Editor State
    private string _postContent = "";
    private List<IBrowserFile> _uploadedFiles = new();
    private List<string> _previewImages = new(); // Data URLs for preview
    private string? _previewVideoUrl;
    
    // Follow-up Comments
    private string _newComment = "";
    private List<string> _comments = new();

    // Scheduling
    private bool _isScheduled;
    private DateTime? _scheduledDate = DateTime.Today;
    private TimeSpan? _scheduledTime = DateTime.Now.TimeOfDay.Add(TimeSpan.FromHours(1));

    private bool _isPosting;

    protected override async Task OnInitializedAsync()
    {
        await LoadProfiles();
    }

    private async Task LoadProfiles()
    {
        _loadingProfiles = true;
        try
        {
            if (LinkedInState.IsAuthenticated)
            {
                var req = new HttpRequestMessage(HttpMethod.Get, "/api/linkedin/profile");
                req.Headers.Add("X-LinkedIn-Token", LinkedInState.AccessToken);
                var res = await Http.SendAsync(req);
                if (res.IsSuccessStatusCode)
                {
                    _linkedInProfile = await res.Content.ReadFromJsonAsync<LinkedInProfileDto>();
                    _linkedInSelected = true; // Auto-select if connected
                }
            }

            if (InstagramState.IsAuthenticated)
            {
                var req = new HttpRequestMessage(HttpMethod.Get, $"/api/instagram/profile?userId={InstagramState.UserId}");
                req.Headers.Add("X-Instagram-Token", InstagramState.AccessToken);
                req.Headers.Add("X-Instagram-UserId", InstagramState.UserId);
                var res = await Http.SendAsync(req);
                if (res.IsSuccessStatusCode)
                {
                    _instagramProfile = await res.Content.ReadFromJsonAsync<InstagramUserDto>();
                    _instagramSelected = true; // Auto-select if connected
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load profiles: {ex.Message}", Severity.Warning);
        }
        finally
        {
            _loadingProfiles = false;
        }
    }

    private void OnLinkedInChanged(bool value) => ToggleLinkedIn(value);
    private void OnInstagramChanged(bool value) => ToggleInstagram(value);

    private void ToggleLinkedIn(bool? value = null)
    {
        if (LinkedInState.IsAuthenticated)
        {
             _linkedInSelected = value ?? !_linkedInSelected;
        }
        else
        {
             Snackbar.Add("Connect LinkedIn first!", Severity.Warning);
             _linkedInSelected = false;
        }
    }

    private void ToggleInstagram(bool? value = null)
    {
        if (InstagramState.IsAuthenticated)
        {
             _instagramSelected = value ?? !_instagramSelected;
        }
        else
        {
             Snackbar.Add("Connect Instagram first!", Severity.Warning);
             _instagramSelected = false;
        }
    }

    private async Task UploadFiles(IReadOnlyList<IBrowserFile> files)
    {
        foreach (var file in files)
        {
            if (_uploadedFiles.Any(f => f.Name == file.Name)) continue;
            
            _uploadedFiles.Add(file);

            // Generate Preview
            if (file.ContentType.StartsWith("image/"))
            {
                var buffer = new byte[file.Size];
                await file.OpenReadStream(20 * 1024 * 1024).ReadAsync(buffer);
                var base64 = Convert.ToBase64String(buffer);
                _previewImages.Add($"data:{file.ContentType};base64,{base64}");
            }
            // For video preview, we might need a different approach or just show a placeholder
        }
    }

    private void RemoveFile(IBrowserFile file)
    {
        _uploadedFiles.Remove(file);
        // Clear previews for simplicity, or manage index-based removal
        _previewImages.Clear(); 
        // Re-generate would be better but keeping it simple for now
    }

    private void AddComment()
    {
        if (!string.IsNullOrWhiteSpace(_newComment))
        {
            _comments.Add(_newComment);
            _newComment = "";
        }
    }

    private async Task SubmitPost()
    {
        _isPosting = true;
        try
        {
            var scheduledDateTime = (_isScheduled && _scheduledDate.HasValue && _scheduledTime.HasValue) 
                ? _scheduledDate.Value.Add(_scheduledTime.Value) 
                : (DateTime?)null;

            // 1. Post to LinkedIn
            if (_linkedInSelected)
            {
                await PostToLinkedIn(scheduledDateTime);
            }

            // 2. Post to Instagram
            if (_instagramSelected)
            {
                await PostToInstagram(scheduledDateTime);
            }
            
            Snackbar.Add("Operation completed!", Severity.Success);
            
            // Clear form
            _postContent = "";
            _uploadedFiles.Clear();
            _previewImages.Clear();
            _comments.Clear();
            _isScheduled = false;

        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isPosting = false;
        }
    }

    private async Task PostToLinkedIn(DateTime? scheduledAt)
    {
         // Logic similar to LinkedIn.razor 
         // Upload media first, then create post
         
         List<string> mediaUrns = new();
         string mediaType = "NONE";
         string? thumbnailUrl = _previewImages.FirstOrDefault(); // Simplified: using the base64 as thumbnail if needed, or null. LinkedIn usually needs a real URL.

         if (_uploadedFiles.Any())
         {
             var first = _uploadedFiles.First();
             mediaType = first.ContentType.StartsWith("video/") ? "VIDEO" : "IMAGE";
             
             foreach(var file in _uploadedFiles)
             {
                 var content = new MultipartFormDataContent();
                 var fileContent = new StreamContent(file.OpenReadStream(50 * 1024 * 1024));
                 fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(file.ContentType);
                 content.Add(fileContent, "file", file.Name);

                 var req = new HttpRequestMessage(HttpMethod.Post, "/api/linkedin/upload");
                 req.Headers.Add("X-LinkedIn-Token", LinkedInState.AccessToken);
                 req.Content = content;
                 
                 var res = await Http.SendAsync(req);
                 if (res.IsSuccessStatusCode)
                 {
                     var uploadDto = await res.Content.ReadFromJsonAsync<LinkedInUploadResponse>();
                     if(uploadDto != null) mediaUrns.Add(uploadDto.AssetUrn);
                 }
             }
         }

         var postReq = new CreateLinkedInPostRequest(_postContent, mediaUrns, mediaType, _comments, scheduledAt, thumbnailUrl);
         var reqMsg = new HttpRequestMessage(HttpMethod.Post, "/api/linkedin/post");
         reqMsg.Headers.Add("X-LinkedIn-Token", LinkedInState.AccessToken);
         reqMsg.Content = JsonContent.Create(postReq);
         
         var response = await Http.SendAsync(reqMsg);
         if (!response.IsSuccessStatusCode) throw new Exception("LinkedIn Post Failed");
    }

    private async Task PostToInstagram(DateTime? scheduledAt)
    {
        // Logic similar to Instagram.razor
        // Currently IG only supports 1 media file in this basic implementation unless we enhanced it
        // We'll take the first file
        
        var file = _uploadedFiles.FirstOrDefault();
        
        var content = new MultipartFormDataContent();
        if (file != null)
        {
            var fileContent = new StreamContent(file.OpenReadStream(50 * 1024 * 1024));
            fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(file.ContentType);
            content.Add(fileContent, "file", file.Name);
            
            // Determine PostType
            var type = file.ContentType.StartsWith("video/") ? InstagramPostType.Reel : InstagramPostType.Post;
            content.Add(new StringContent(type.ToString()), "postType");
        }
        else
        {
            // IG requires media for now? Or maybe just text-only not supported? 
            // Standard IG requires media.
            if (string.IsNullOrWhiteSpace(_previewVideoUrl) && !_previewImages.Any())
            {
               throw new Exception("Instagram requires media (image/video).");
            }
        }

        content.Add(new StringContent(_postContent), "caption");
        
        // Handle Multiple Comments
        if (_comments.Any())
        {
            var joined = string.Join("|||", _comments);
            content.Add(new StringContent(joined), "comments");
        }

        if (scheduledAt.HasValue)
        {
             content.Add(new StringContent(scheduledAt.Value.ToString("O")), "scheduledFor");
        }

        var req = new HttpRequestMessage(HttpMethod.Post, "/api/instagram/post");
        req.Headers.Add("X-Instagram-Token", InstagramState.AccessToken);
        req.Headers.Add("X-Instagram-UserId", InstagramState.UserId);
        req.Content = content;

        var res = await Http.SendAsync(req);
        if (!res.IsSuccessStatusCode) 
        {
            var err = await res.Content.ReadAsStringAsync();
            throw new Exception($"Instagram Failed: {err}");
        }
    }
}
