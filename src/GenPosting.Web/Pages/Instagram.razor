@page "/instagram"
@using GenPosting.Shared.DTOs
@using GenPosting.Web.Services
@inject HttpClient Http
@inject NavigationManager Nav
@inject IInstagramStateService InstagramState
@inject ISnackbar Snackbar
@inject IDialogService DialogService

@if (!InstagramState.IsAuthenticated)
{
    <MudPaper Class="pa-8 d-flex flex-column align-center justify-center" Elevation="2">
        <MudIcon Icon="@Icons.Custom.Brands.Instagram" Size="Size.Large" Color="Color.Secondary" Class="mb-4" Style="font-size: 4rem;" />
        <MudText Typo="Typo.h5" Class="mb-4">Instagram Not Connected</MudText>
        <MudText Typo="Typo.body1" Class="mb-6">Please connect your Instagram account in Settings to create content.</MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large" Href="/settings" StartIcon="@Icons.Material.Filled.Settings">
            Go to Settings
        </MudButton>
    </MudPaper>
}
else
{
    // Profile Header & Skeletons
    <MudPaper Class="pa-4 mb-4 d-flex align-center gap-4" Elevation="1">
        @if (_isLoadingProfile)
        {
             <MudSkeleton SkeletonType="SkeletonType.Circle" Width="64px" Height="64px" />
             <div>
                 <MudSkeleton Width="150px" Height="30px" Class="mb-1"/>
                 <MudSkeleton Width="100px" Height="20px" />
             </div>
        }
        else if (_profile != null)
        {
            <MudAvatar Size="Size.Large">
                @if (!string.IsNullOrEmpty(_profile.ProfilePictureUrl))
                {
                    <MudImage Src="@_profile.ProfilePictureUrl" />
                }
                else
                {
                    @(_profile.Username.FirstOrDefault())
                }
            </MudAvatar>
            <div>
                <MudText Typo="Typo.h6">@_profile.Username</MudText>
                <MudText Typo="Typo.caption">@_profile.AccountType</MudText>
            </div>
        }
        <MudSpacer />
        <MudText Typo="Typo.caption" Class="mr-2">Metrics for Last 30 Days</MudText>
    </MudPaper>

    <MudGrid Class="mb-6">
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4 d-flex flex-column align-center gap-2" Elevation="2">
                <MudIcon Icon="@Icons.Material.Filled.People" Color="Color.Primary" Size="Size.Large" />
                @if (_isLoadingProfile)
                {
                    <MudSkeleton Width="80px" Height="40px" />
                }
                else
                {
                    <MudText Typo="Typo.h4">@(_profile?.FollowersCount.ToString("N0") ?? "0")</MudText>
                }
                <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Followers</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4 d-flex flex-column align-center gap-2" Elevation="2">
                <MudIcon Icon="@Icons.Material.Filled.Public" Color="Color.Success" Size="Size.Large" />
                 @if(_isLoadingInsights) 
                 { 
                     <MudSkeleton Width="80px" Height="40px" /> 
                 } 
                 else 
                 { 
                    <MudText Typo="Typo.h4">@(_accountInsights?.Reach?.TotalValue.ToString("N0") ?? "0")</MudText>
                 }
                <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Total Reach</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4 d-flex flex-column align-center gap-2" Elevation="2">
                <MudIcon Icon="@Icons.Material.Filled.GroupAdd" Color="Color.Warning" Size="Size.Large" />
                 @if(_isLoadingInsights) 
                 { 
                     <MudSkeleton Width="80px" Height="40px" /> 
                 } 
                 else 
                 { 
                    <MudText Typo="Typo.h4">@(_accountInsights?.AccountsEngaged?.TotalValue.ToString("N0") ?? "0")</MudText>
                 }
                <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Accounts Engaged</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4 d-flex flex-column align-center gap-2" Elevation="2">
                <MudIcon Icon="@Icons.Material.Filled.PersonSearch" Color="Color.Info" Size="Size.Large" />
                 @if(_isLoadingInsights) 
                 { 
                     <MudSkeleton Width="80px" Height="40px" /> 
                 } 
                 else 
                 { 
                    <MudText Typo="Typo.h4">@(_accountInsights?.ProfileViews?.TotalValue.ToString("N0") ?? "0")</MudText>
                 }
                <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Profile Views</MudText>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
        <MudTabPanel Text="Posts" Icon="@Icons.Material.Filled.Dashboard">
            <MudGrid>
                <MudItem xs="12">
                    <MudPaper Class="pa-4">
                         <div class="d-flex justify-space-between align-center mb-4">
                             <MudText Typo="Typo.h6">Your Posts</MudText>
                             <MudButton StartIcon="@Icons.Material.Filled.Refresh" Variant="Variant.Outlined" OnClick="LoadPosts" Disabled="_isLoadingPosts">Refresh</MudButton>
                         </div>
                         
                         @if (_isLoadingPosts)
                         {
                             <!-- Skeletons for Posts Table -->
                             <MudSimpleTable Elevation="0" Hover="false">
                                 <thead>
                                     <tr>
                                         <th>Media</th>
                                         <th>Caption</th>
                                         <th>Type</th>
                                         <th>Reactions</th>
                                         <th>Date</th>
                                         <th>Actions</th>
                                     </tr>
                                 </thead>
                                 <tbody>
                                     @for(int i=0; i<3; i++)
                                     {
                                         <tr>
                                             <td><MudSkeleton SkeletonType="SkeletonType.Rectangle" Width="60px" Height="60px" Class="rounded"/></td>
                                             <td><MudSkeleton Width="200px" /></td>
                                             <td><MudSkeleton Width="60px" Height="30px" Class="rounded-pill"/></td>
                                             <td><MudSkeleton Width="100px" /></td>
                                             <td><MudSkeleton Width="100px" /></td>
                                             <td><MudSkeleton Width="80px" Height="30px" /></td>
                                         </tr>
                                     }
                                 </tbody>
                             </MudSimpleTable>
                         }
                         else
                         {
                             <MudTable Items="@_posts" Hover="true" Breakpoint="Breakpoint.Sm" Elevation="0">
                                <HeaderContent>
                                    <MudTh>Media</MudTh>
                                    <MudTh>Caption</MudTh>
                                    <MudTh>Type</MudTh>
                                    <MudTh>Reactions</MudTh>
                                    <MudTh>Date</MudTh>
                                    <MudTh>Actions</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Media">
                                        <MudImage Src="@(string.IsNullOrEmpty(context.ThumbnailUrl) ? context.MediaUrl : context.ThumbnailUrl)" 
                                                  Width="60" Height="60" ObjectFit="ObjectFit.Cover" Class="rounded" />
                                    </MudTd>
                                    <MudTd DataLabel="Caption">
                                        <MudTooltip Text="@context.Caption">
                                            <MudText Typo="Typo.body2" Style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; max-width: 300px;">
                                                @context.Caption
                                            </MudText>
                                        </MudTooltip>
                                    </MudTd>
                                    <MudTd DataLabel="Type">
                                        <MudChip T="string" Size="Size.Small" Color="@(context.MediaType == "VIDEO" ? Color.Secondary : Color.Primary)">@context.MediaType</MudChip>
                                    </MudTd>
                                    <MudTd DataLabel="Reactions">
                                        <div class="d-flex gap-2">
                                            <MudChip T="string" Icon="@Icons.Material.Filled.Favorite" Size="Size.Small" Color="Color.Error" Variant="Variant.Outlined">@context.LikeCount</MudChip>
                                            <MudChip T="string" Icon="@Icons.Material.Filled.Comment" Size="Size.Small" Color="Color.Info" Variant="Variant.Outlined">@context.CommentsCount</MudChip>
                                        </div>
                                    </MudTd>
                                    <MudTd DataLabel="Date">
                                         <MudText Typo="Typo.caption">
                                            @(DateTimeOffset.TryParse(context.Timestamp, out var dt) ? dt.ToString("g") : context.Timestamp)
                                         </MudText>
                                    </MudTd>
                                    <MudTd DataLabel="Actions">
                                         <MudStack Row="true">
                                            <MudButton Variant="Variant.Filled" Size="Size.Small" Color="Color.Primary" OnClick="@(() => ShowInsights(context))">Insights</MudButton>
                                            <MudIconButton Icon="@Icons.Material.Filled.OpenInNew" Href="@context.Permalink" Target="_blank" Size="Size.Small" />
                                         </MudStack>
                                    </MudTd>
                                </RowTemplate>
                                <PagerContent>
                                    <MudTablePager />
                                </PagerContent>
                            </MudTable>
                        }
                    </MudPaper>
                </MudItem>
            </MudGrid>
        </MudTabPanel>
        <MudTabPanel Text="Community" Icon="@Icons.Material.Filled.Forum">
            <MudPaper Class="pa-4">
                 <div class="d-flex justify-space-between align-center mb-4">
                     <MudText Typo="Typo.h6">Recent Comments</MudText>
                     <MudButton StartIcon="@Icons.Material.Filled.Refresh" OnClick="LoadComments" Disabled="_isLoadingComments">Refresh</MudButton>
                 </div>
                 
                 @if (_isLoadingComments)
                 {
                     <MudList T="string">
                        @for (int i=0; i<3; i++)
                        {
                            <MudListItem>
                                <div class="d-flex gap-4 align-center">
                                    <MudSkeleton SkeletonType="SkeletonType.Rectangle" Width="50px" Height="50px" Class="rounded" />
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-space-between mb-2">
                                            <MudSkeleton Width="120px" Height="20px" />
                                            <MudSkeleton Width="60px" Height="15px" />
                                        </div>
                                        <MudSkeleton Width="80%" Height="15px" Class="mb-1" />
                                        <MudSkeleton Width="40%" Height="15px" />
                                    </div>
                                </div>
                            </MudListItem>
                            <MudDivider />
                        }
                     </MudList>
                 }
                 else
                 {
                     <MudList T="string">
                         @foreach (var comment in _recentComments)
                         {
                             <MudListItem>
                                <div class="d-flex gap-4">
                                    <MudImage Src="@comment.MediaUrl" Width="50" Height="50" ObjectFit="ObjectFit.Cover" Class="rounded" />
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-space-between">
                                            <MudText Typo="Typo.subtitle2"><b>@comment.Username</b></MudText>
                                            <MudText Typo="Typo.caption">@comment.Timestamp</MudText>
                                        </div>
                                        <MudText Typo="Typo.body2">@comment.Text</MudText>
                                        <div class="d-flex gap-2 mt-2 align-center">
                                             <MudIcon Icon="@Icons.Material.Filled.Favorite" Size="Size.Small" Color="Color.Error" />
                                             <MudText Typo="Typo.caption">@comment.LikeCount</MudText>
                                             <MudButton Variant="Variant.Text" Size="Size.Small" Color="Color.Primary" OnClick="@(() => OpenReplyDialog(comment))">Reply</MudButton>
                                        </div>
                                    </div>
                                </div>
                             </MudListItem>
                             <MudDivider />
                         }
                         @if(!_recentComments.Any())
                         {
                             <MudText Class="pa-4" Align="Align.Center">No recent comments found.</MudText>
                         }
                     </MudList>
                 }
            </MudPaper>
        </MudTabPanel>
    </MudTabs>
}

@code {
    private InstagramUserDto? _profile;
    private bool _isLoadingProfile = false; // Added loading state for profile
    
    // Insights
    private InstagramAccountInsightsResponse? _accountInsights;
    private bool _isLoadingInsights = false;
    
    // Posts List
    private List<InstagramMediaDto> _posts = new();
    private bool _isLoadingPosts = false;

    // Comments
    private List<InstagramCommentDto> _recentComments = new();
    private bool _isLoadingComments = false;

    protected override async Task OnInitializedAsync()
    {
        if (InstagramState.IsAuthenticated)
        {
            // Start all tasks concurrently so all skeletons appear immediately
            var profileTask = LoadProfile();
            var insightsTask = LoadAccountInsights();
            var postsTask = LoadPosts();
            var commentsTask = LoadComments();

            await Task.WhenAll(profileTask, insightsTask, postsTask, commentsTask);
        }
    }

    private async Task LoadAccountInsights()
    {
        _isLoadingInsights = true;
        try 
        {
             // Omit 'from' and 'to' to let backend default to "Last 30 Days" which respects the API limit
             var request = new HttpRequestMessage(HttpMethod.Get, $"/api/instagram/insights/account?userId={InstagramState.UserId}");
             request.Headers.Add("X-Instagram-Token", InstagramState.AccessToken);
             
             var response = await Http.SendAsync(request);
             if (response.IsSuccessStatusCode)
             {
                 _accountInsights = await response.Content.ReadFromJsonAsync<InstagramAccountInsightsResponse>();
             }
        }
        catch (Exception ex)
        {
             Console.WriteLine($"Error loading insights: {ex.Message}");
        }
        finally
        {
            _isLoadingInsights = false;
        }
    }

    private async Task LoadProfile()
    {
        _isLoadingProfile = true;
        try 
        {
            var request = new HttpRequestMessage(HttpMethod.Get, $"/api/instagram/profile?userId={InstagramState.UserId}");
            request.Headers.Add("X-Instagram-Token", InstagramState.AccessToken);
            var response = await Http.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                _profile = await response.Content.ReadFromJsonAsync<InstagramUserDto>();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading profile: {ex.Message}");
        }
        finally 
        {
            _isLoadingProfile = false;
        }
    }

    private async Task LoadPosts()
    {
        _isLoadingPosts = true;
        try 
        {
             var request = new HttpRequestMessage(HttpMethod.Get, "/api/instagram/media");
             request.Headers.Add("X-Instagram-Token", InstagramState.AccessToken);
             request.Headers.Add("X-Instagram-UserId", InstagramState.UserId);
             var response = await Http.SendAsync(request);
             if (response.IsSuccessStatusCode)
             {
                 var result = await response.Content.ReadFromJsonAsync<InstagramMediaListResponse>();
                 _posts = result?.Data ?? new();
             }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load posts: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoadingPosts = false;
        }
    }

    private void ShowInsights(InstagramMediaDto post)
    {
        var parameters = new DialogParameters { ["MediaId"] = post.Id, ["AccessToken"] = InstagramState.AccessToken }; 
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        DialogService.Show<GenPosting.Web.Components.InstagramInsightsDialog>($"Insights: {post.MediaType}", parameters, options);
    }

    private async Task LoadComments()
    {
        _isLoadingComments = true;
        try 
        {
             var request = new HttpRequestMessage(HttpMethod.Get, "/api/instagram/comments/recent");
             request.Headers.Add("X-Instagram-Token", InstagramState.AccessToken);
             request.Headers.Add("X-Instagram-UserId", InstagramState.UserId);
             var response = await Http.SendAsync(request);
             if (response.IsSuccessStatusCode)
             {
                 var result = await response.Content.ReadFromJsonAsync<InstagramCommentListResponse>();
                 _recentComments = result?.Data ?? new();
             }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading comments: {ex.Message}");
        }
        finally
        {
            _isLoadingComments = false;
        }
    }

    private async Task OpenReplyDialog(InstagramCommentDto comment)
    {
        var parameters = new DialogParameters { ["Comment"] = comment, ["AccessToken"] = InstagramState.AccessToken };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<GenPosting.Web.Components.InstagramReplyDialog>("Reply to Comment", parameters, options);
        var result = await dialog.Result;
        
        if (!result.Canceled)
        {
            Snackbar.Add("Reply sent!", Severity.Success);
            await LoadComments();
        }
    }
}
