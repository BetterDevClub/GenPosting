@page "/instagram"
@using GenPosting.Shared.DTOs
@using GenPosting.Web.Services
@inject HttpClient Http
@inject NavigationManager Nav
@inject IInstagramStateService InstagramState
@inject ISnackbar Snackbar

<PageTitle>Instagram Dashboard</PageTitle>

<MudText Typo="Typo.h3" Class="mb-4">Instagram Dashboard</MudText>

@if (!InstagramState.IsAuthenticated)
{
    <MudPaper Class="pa-8 d-flex flex-column align-center justify-center" Elevation="2">
        <MudIcon Icon="@Icons.Custom.Brands.Instagram" Size="Size.Large" Color="Color.Secondary" Class="mb-4" Style="font-size: 4rem;" />
        <MudText Typo="Typo.h5" Class="mb-4">Instagram Not Connected</MudText>
        <MudText Typo="Typo.body1" Class="mb-6">Please connect your Instagram account in Settings to create content.</MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large" Href="/settings" StartIcon="@Icons.Material.Filled.Settings">
            Go to Settings
        </MudButton>
    </MudPaper>
}
else
{
    @if (_profile != null)
    {
        <MudPaper Class="pa-4 mb-4 d-flex align-center gap-4" Elevation="1">
            <MudAvatar Size="Size.Large">
                @if (!string.IsNullOrEmpty(_profile.ProfilePictureUrl))
                {
                    <MudImage Src="@_profile.ProfilePictureUrl" />
                }
                else
                {
                    @(_profile.Username.FirstOrDefault())
                }
            </MudAvatar>
            <div>
                <MudText Typo="Typo.h6">@_profile.Username</MudText>
                <MudText Typo="Typo.caption">@_profile.AccountType</MudText>
            </div>
        </MudPaper>
    }

    <MudGrid>
        <MudItem xs="12">
            <MudPaper Class="pa-4">
                <MudText Typo="Typo.h6" Class="mb-4">Create New Content</MudText>
                
                <MudGrid>
                    <MudItem xs="12" md="6">
                        @* Post Type Selector *@
                        <MudSelect T="InstagramPostType" Label="Content Type" @bind-Value="_postType" Variant="Variant.Outlined" Class="mb-4" AnchorOrigin="Origin.BottomCenter">
                            <MudSelectItem Value="@InstagramPostType.Post">Post (Feed)</MudSelectItem>
                            <MudSelectItem Value="@InstagramPostType.Reel">Reel</MudSelectItem>
                            <MudSelectItem Value="@InstagramPostType.Story">Story</MudSelectItem>
                        </MudSelect>

                        @* Caption (Hidden for Stories usually, but let's keep it mostly optional) *@
                        @if (_postType != InstagramPostType.Story)
                        {
                            <MudTextField @bind-Value="_caption" 
                                        Label="Caption" 
                                        Variant="Variant.Outlined" 
                                        Lines="5" 
                                        Class="mb-4" 
                                        Adornment="Adornment.End" 
                                        AdornmentIcon="@Icons.Material.Filled.Edit" />
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Info" Class="mb-4">Stories do not support API-based captions. Text must be burned into the image/video.</MudAlert>
                        }

                        @* File Upload *@
                        <MudFileUpload T="IBrowserFile" FilesChanged="OnFilesChanged" Accept=".jpg, .jpeg, .png, .mp4, .mov">
                             <ActivatorContent>
                                <MudButton Variant="Variant.Outlined" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.PhotoCamera">
                                    Upload Media (@(_postType))
                                </MudButton>
                            </ActivatorContent>
                        </MudFileUpload>

                        @if (_file != null)
                        {
                             <MudPaper Class="d-flex align-center justify-space-between pa-2 mt-2" Outlined="true">
                                <div class="d-flex align-center gap-2">
                                    <MudIcon Icon="@Icons.Material.Filled.FilePresent" />
                                    <MudText Typo="Typo.body2">@_file.Name (@(_file.Size / 1024) KB)</MudText>
                                </div>
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="ClearFile" Size="Size.Small"/>
                            </MudPaper>
                        }

                        <MudSwitch @bind-Value="_isScheduled" Label="Schedule for later" Color="Color.Primary" Class="mt-4" />
                        
                        @if (_isScheduled)
                        {
                            <div class="d-flex gap-4 mt-2 mb-4">
                                <MudDatePicker Label="Date" @bind-Date="_scheduledDate" MinDate="DateTime.Today" Variant="Variant.Outlined" />
                                <MudTimePicker Label="Time" @bind-Time="_scheduledTime" Variant="Variant.Outlined" />
                            </div>
                        }
                        
                        <MudText Typo="Typo.subtitle2" Class="mb-2 mt-4">Follow-up Comments</MudText>
                        <MudText Typo="Typo.caption" Class="mb-2 d-block">These comments will be posted immediately after the post is published in the order shown.</MudText>
                        
                        @for (int i = 0; i < _comments.Count; i++)
                        {
                            var index = i; 
                            <div class="d-flex gap-2 mb-2">
                                <MudTextField Value="@_comments[index]" ValueChanged="@((string s) => _comments[index] = s)" 
                                            Label="@($"Comment #{index+1}")" 
                                            Variant="Variant.Outlined" 
                                            Margin="Margin.Dense" 
                                            FullWidth="true" 
                                            Lines="2"/>
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => RemoveComment(index))" />
                            </div>
                        }
                        <MudButton StartIcon="@Icons.Material.Filled.AddComment" Variant="Variant.Text" Color="Color.Secondary" OnClick="AddCommentField" Class="mb-4">Add Follow-up Comment</MudButton>

                        <div class="d-flex justify-end gap-2 mt-6">
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="PublishPost" Disabled="@(_file == null || _isPosting)">
                                @(_isPosting ? "Processing..." : (_isScheduled ? "Schedule Post" : "Publish Now"))
                            </MudButton>
                        </div>

                    </MudItem>
                    
                    <MudItem xs="12" md="6">
                         @* Preview Mockup *@
                        <MudCard Outlined="true" Class="pa-4" Style="background-color: #fafafa; height: 100%;">
                            <MudText Typo="Typo.overline" Class="mb-2">Preview (@_postType)</MudText>
                            
                            <div class="d-flex justify-center">
                                @if (_postType == InstagramPostType.Story)
                                {
                                    @* Mobile Portrait Aspect Ratio *@
                                    <MudPaper Height="400px" Width="225px" Elevation="3" Class="d-flex align-center justify-center overflow-hidden position-relative">
                                         @if (_file != null)
                                         {
                                             <MudIcon Icon="@Icons.Material.Filled.Image" Size="Size.Large" />
                                             <MudText Typo="Typo.caption" Class="absolute-center">Media Preview</MudText>
                                         }
                                         else
                                         {
                                             <MudText Typo="Typo.caption" Color="Color.Default">No Media</MudText>
                                         }
                                    </MudPaper>
                                }
                                else
                                {
                                    @* Feed Post / Reel Aspect Ratio *@
                                    <MudPaper Width="300px" Class="pb-4" Elevation="1">
                                         <div class="d-flex align-center pa-2 gap-2">
                                             <MudSkeleton SkeletonType="SkeletonType.Circle" Width="30px" Height="30px"/>
                                             <MudSkeleton SkeletonType="SkeletonType.Text" Width="100px"/>
                                         </div>
                                         <MudPaper Height="300px" Width="300px" Square="true" Class="d-flex align-center justify-center grey lighten-3">
                                             @if (_file != null)
                                             {
                                                  <MudIcon Icon="@Icons.Material.Filled.Image" Size="Size.Large"/>
                                             }
                                             else
                                             {
                                                  <MudText Typo="Typo.caption">Media Placeholder</MudText>
                                             }
                                         </MudPaper>
                                         <div class="pa-2">
                                             @if (!string.IsNullOrEmpty(_caption))
                                             {
                                                 <MudText Typo="Typo.body2"><b>username</b> @_caption</MudText>
                                             }
                                             else 
                                             {
                                                 <MudSkeleton SkeletonType="SkeletonType.Text" Count="2"/>
                                             }
                                         </div>
                                    </MudPaper>
                                }
                            </div>
                        </MudCard>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudItem>
    </MudGrid>
}

@code {
    private InstagramUserDto? _profile;
    private InstagramPostType _postType = InstagramPostType.Post;
    private string _caption = "";
    private List<string> _comments = new List<string>(); // Changed to List
    private IBrowserFile? _file;
    private bool _isPosting = false;
    
    // Scheduling
    private bool _isScheduled = false;
    private DateTime? _scheduledDate = DateTime.Today;
    private TimeSpan? _scheduledTime = DateTime.Now.TimeOfDay.Add(TimeSpan.FromMinutes(10));

    protected override async Task OnInitializedAsync()
    {
        if (InstagramState.IsAuthenticated)
        {
            await LoadProfile();
        }
    }

    private async Task LoadProfile()
    {
        try 
        {
            var request = new HttpRequestMessage(HttpMethod.Get, $"/api/instagram/profile?userId={InstagramState.UserId}");
            request.Headers.Add("X-Instagram-Token", InstagramState.AccessToken);
            var response = await Http.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                _profile = await response.Content.ReadFromJsonAsync<InstagramUserDto>();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading profile: {ex.Message}");
        }
    }

    private void OnFilesChanged(IBrowserFile file)
    {
        _file = file;
         // TODO: Generate preview URL for local display if needed, but risky with Blazor WebAssembly limitations on memory
    }

    private void ClearFile()
    {
        _file = null;
    }

    private void AddCommentField()
    {
        _comments.Add("");
    }

    private void RemoveComment(int index)
    {
        if (index >= 0 && index < _comments.Count)
        {
            _comments.RemoveAt(index);
        }
    }

    private async Task PublishPost()
    {
        if (_file == null) return;

        _isPosting = true;
        try
        {
            // Step 1: Upload Media to Backend
            // In a real app we'd upload to a specific "Upload" endpoint that returns a temporary public URL
            // For now, we'll assume a direct post endpoint that handles multipart/form-data
            
            var content = new MultipartFormDataContent();
            var fileContent = new StreamContent(_file.OpenReadStream(maxAllowedSize: 50 * 1024 * 1024)); // Increased to 50MB for video
            fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(_file.ContentType);
            
            content.Add(fileContent, "file", _file.Name);
            content.Add(new StringContent(_caption), "caption");
            content.Add(new StringContent(_postType.ToString()), "postType");

            if (_comments.Any())
            {
                // Join comments with a delimiter that is unlikely to be in user text. 
                // Using ||| as agreed with backend convention.
                var joinedComments = string.Join("|||", _comments.Where(c => !string.IsNullOrWhiteSpace(c)));
                if (!string.IsNullOrEmpty(joinedComments))
                {
                    content.Add(new StringContent(joinedComments), "comments");
                }
            }

            if (_isScheduled && _scheduledDate.HasValue && _scheduledTime.HasValue)
            {
                var dt = _scheduledDate.Value.Add(_scheduledTime.Value);
                var offset = DateTimeOffset.Now.Offset;
                var scheduledFor = new DateTimeOffset(dt, offset);
                content.Add(new StringContent(scheduledFor.ToString("O")), "scheduledFor");
            }

            var request = new HttpRequestMessage(HttpMethod.Post, "/api/instagram/post");
            request.Headers.Add("X-Instagram-Token", InstagramState.AccessToken);
            request.Headers.Add("X-Instagram-UserId", InstagramState.UserId);
            request.Content = content;

            var response = await Http.SendAsync(request);

            if (response.IsSuccessStatusCode)
            {
                var msg = _isScheduled ? "Post scheduled successfully!" : "Posted to Instagram successfully!";
                Snackbar.Add(msg, Severity.Success);
                // Clear form
                _caption = "";
                _file = null;
                _isScheduled = false;
                _comments.Clear();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Failed: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isPosting = false;
        }
    }
}
