@page "/linkedin"
@using GenPosting.Shared.DTOs
@using GenPosting.Web.Services
@inject HttpClient Http
@inject NavigationManager Nav
@inject ILinkedInStateService LinkedInState
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>LinkedIn Dashboard</PageTitle>

<MudText Typo="Typo.h3" Class="mb-4">LinkedIn Dashboard</MudText>

@if (!LinkedInState.IsAuthenticated)
{
    <MudPaper Class="pa-8 d-flex flex-column align-center justify-center" Elevation="2">
        <MudIcon Icon="@Icons.Custom.Brands.LinkedIn" Size="Size.Large" Color="Color.Primary" Class="mb-4" Style="font-size: 4rem;" />
        <MudText Typo="Typo.h5" Class="mb-4">LinkedIn Not Connected</MudText>
        <MudText Typo="Typo.body1" Class="mb-6">Please connect your LinkedIn account in Settings to view posts and create content.</MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large" Href="/settings" StartIcon="@Icons.Material.Filled.Settings">
            Go to Settings
        </MudButton>
    </MudPaper>
}
else
{
    @if (_profile != null)
    {
        <MudPaper Class="pa-4 mb-4 d-flex align-center gap-4" Elevation="1">
            <MudAvatar Size="Size.Large">
                @if (!string.IsNullOrEmpty(_profile.PictureUrl))
                {
                    <MudImage Src="@_profile.PictureUrl" />
                }
                else
                {
                    @(_profile.Name.FirstOrDefault())
                }
            </MudAvatar>
            <div>
                <MudText Typo="Typo.h6">@_profile.Name</MudText>
                <MudText Typo="Typo.body2" Color="Color.Success">Active Connection</MudText>
            </div>
        </MudPaper>
    }

    <MudGrid>
        <MudItem xs="12">
            <MudPaper Class="pa-4">
                <MudText Typo="Typo.h6" Class="mb-4">Create New Post</MudText>
                
                <MudGrid>
                    <MudItem xs="12" md="6" Class="position-relative">
                            <MudTextField @bind-Value="_newPostContent" 
                                        Label="What do you want to talk about?" 
                                        Variant="Variant.Outlined" 
                                        Lines="8" 
                                        Class="mb-4" 
                                        Adornment="Adornment.End" 
                                        AdornmentIcon="@Icons.Material.Filled.Edit"
                                        Immediate="true" />


                            <MudFileUpload T="IReadOnlyList<IBrowserFile>" FilesChanged="OnFilesChanged" MaximumFileCount="9" Accept=".jpg, .jpeg, .png, .gif, .mp4">
                            <ActivatorContent>
                                <MudButton Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Filled.AttachFile">
                                    Attach Media (Images or 1 Video)
                                </MudButton>
                            </ActivatorContent>
                            </MudFileUpload>

                            @if (_files != null && _files.Any())
                            {
                                <MudList T="IBrowserFile" Dense="true">
                                    @foreach (var file in _files)
                                    {
                                        <MudListItem Icon="@Icons.Material.Filled.FilePresent">
                                            @file.Name (@(file.Size / 1024) KB)
                                        </MudListItem>
                                    }
                                </MudList>
                                <MudButton Variant="Variant.Text" Color="Color.Error" OnClick="ClearFiles" Class="mt-2">Clear Media</MudButton>
                            }

                            <MudDivider Class="my-4"/>
                            <MudText Typo="Typo.subtitle2" Class="mb-2">Follow-up Comments</MudText>
                            @for (int i = 0; i < _comments.Count; i++)
                            {
                                var index = i; 
                                <div class="d-flex gap-2 mb-2">
                                <MudTextField Value="@_comments[index]" ValueChanged="@((string s) => _comments[index] = s)" Label="@($"Comment #{index+1}")" Variant="Variant.Outlined" Margin="Margin.Dense" FullWidth="true"/>
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => RemoveComment(index))" />
                                </div>
                            }
                            <MudButton StartIcon="@Icons.Material.Filled.AddComment" Variant="Variant.Text" Color="Color.Secondary" OnClick="AddCommentField">Add Follow-up Comment</MudButton>

                            @* Scheduling UI *@
                            @if (_showScheduleOptions)
                            {
                                <MudPaper Class="pa-4 my-4" Elevation="0" Outlined="true">
                                    <MudText Typo="Typo.subtitle2" Class="mb-2">Schedule Post</MudText>
                                    <div class="d-flex gap-4">
                                        <MudDatePicker Label="Date" @bind-Date="_scheduledDate" MinDate="DateTime.Today" />
                                        <MudTimePicker Label="Time" @bind-Time="_scheduledTime" />
                                    </div>
                                    <MudButton Variant="Variant.Text" Color="Color.Default" OnClick="@(() => _showScheduleOptions = false)" Class="mt-2">Cancel Schedule</MudButton>
                                </MudPaper>
                            }

                            <div class="d-flex gap-2 mt-4">
                            @if (!_showScheduleOptions)
                            {
                                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="CreatePost" Disabled="@IsPostDisabled" FullWidth="true" Class="py-2" StartIcon="@Icons.Material.Filled.Send">
                                    @if (_posting)
                                    {
                                        <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true"/>
                                        <MudText Class="ms-2">Posting... @(_uploadProgress > 0 ? $"{_uploadProgress}%" : "")</MudText>
                                    }
                                    else
                                    {
                                        <MudText>Post Now</MudText>
                                    }
                                </MudButton>
                                <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="@(() => _showScheduleOptions = true)" Disabled="@IsPostDisabled" StartIcon="@Icons.Material.Filled.Schedule">
                                    Schedule
                                </MudButton>
                            }
                            else
                            {
                                <MudButton Variant="Variant.Filled" Color="Color.Secondary" OnClick="SchedulePost" Disabled="@IsPostDisabled" FullWidth="true" Class="py-2" StartIcon="@Icons.Material.Filled.Check">
                                        @if (_posting)
                                        {
                                            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true"/>
                                            <MudText Class="ms-2">Scheduling...</MudText>
                                        }
                                        else
                                        {
                                            <MudText>Confirm Schedule</MudText>
                                        }
                                </MudButton>
                            }
                            </div>
                    </MudItem>
                    
                    <MudItem xs="12" md="6">
                            <GenPosting.Web.Components.LinkedInPostPreview Content="@_newPostContent" AuthorName="@(_profile?.Name ?? "Your Name")" AuthorAvatarUrl="@(_profile?.PictureUrl)" Images="@_previewImages" VideoUrl="@_previewVideoUrl" /> 
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudItem>
    </MudGrid>
}

@code {
    private LinkedInProfileDto? _profile;
    private bool _posting = false;
    private string _newPostContent = string.Empty;
    
    private IReadOnlyList<IBrowserFile>? _files;
    private List<string> _previewImages = new();
    private string? _previewVideoUrl;
    private int _uploadProgress = 0;
    
    private List<string> _comments = new();

    // Scheduling
    private bool _showScheduleOptions = false;
    private DateTime? _scheduledDate = DateTime.Today;
    private TimeSpan? _scheduledTime = DateTime.Now.TimeOfDay.Add(TimeSpan.FromMinutes(30)); 

    private bool IsPostDisabled => _posting || (string.IsNullOrWhiteSpace(_newPostContent) && (_files == null || !_files.Any()));
    

    private void AddCommentField() => _comments.Add(string.Empty);
    private void RemoveComment(int index)
    {
         if (index >= 0 && index < _comments.Count) _comments.RemoveAt(index);
    }

    protected override async Task OnInitializedAsync()
    {
        if (LinkedInState.IsAuthenticated)
        {
            await LoadProfile();
        }
    }

    private async Task OnFilesChanged(IReadOnlyList<IBrowserFile> files)
    {
        _files = files;
        _previewImages.Clear();
        _previewVideoUrl = null;

        if (files == null || !files.Any()) return;

        var first = files.First();
        var isVideo = first.ContentType.StartsWith("video/", StringComparison.OrdinalIgnoreCase);
        
        if (isVideo)
        {
            if (files.Count > 1) 
            {
                Snackbar.Add("You can only upload one video at a time.", Severity.Warning);
                _files = null;
                return;
            }
            _previewVideoUrl = "VIDEO_SELECTED"; // Placeholder as we can't easily preview video file stream
        }
        else
        {
            foreach(var f in files)
            {
                if (f.ContentType.StartsWith("video/", StringComparison.OrdinalIgnoreCase))
                {
                     Snackbar.Add("Cannot mix images and video.", Severity.Warning);
                     _files = null;
                     _previewImages.Clear();
                     return;
                }
                
                try 
                {
                    // resizing for preview to save memory and speed up
                    var resized = await f.RequestImageFileAsync(f.ContentType, 600, 600);
                    var buffer = new byte[resized.Size];
                    await resized.OpenReadStream().ReadAsync(buffer);
                    var base64 = Convert.ToBase64String(buffer);
                    _previewImages.Add($"data:{f.ContentType};base64,{base64}");
                } 
                catch (Exception ex) 
                {
                    Console.WriteLine($"Preview error: {ex.Message}");
                }
            }
        }
    }

    private void ClearFiles()
    {
        _files = null;
        _previewImages.Clear();
        _previewVideoUrl = null;
    }

    private async Task LoadProfile()
    {
        try 
        {
            var request = new HttpRequestMessage(HttpMethod.Get, "/api/linkedin/profile");
            request.Headers.Add("X-LinkedIn-Token", LinkedInState.AccessToken);
            var response = await Http.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                _profile = await response.Content.ReadFromJsonAsync<LinkedInProfileDto>();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading profile: {ex.Message}");
        }
    }

    private async Task SchedulePost()
    {
        if (_scheduledDate == null || _scheduledTime == null)
        {
            Snackbar.Add("Please select both date and time.", Severity.Warning);
            return;
        }

        var scheduledDateTime = _scheduledDate.Value.Add(_scheduledTime.Value);
        // Use local to ensure user understands what he selected, but convert to offset carefully
        // Assuming browser time is local, we treat this as local time and send Offset
        var offset = DateTimeOffset.Now.Offset; 
        var scheduledAt = new DateTimeOffset(scheduledDateTime, offset);

        if (scheduledAt <= DateTimeOffset.Now)
        {
            Snackbar.Add("Scheduled time must be in the future.", Severity.Warning);
            return;
        }

        await SubmitPost(scheduledAt);
    }

    private async Task CreatePost()
    {
        await SubmitPost(null);
    }

    private async Task SubmitPost(DateTimeOffset? scheduledAt)
    {
        if (IsPostDisabled) return;

        _posting = true;
        _uploadProgress = 0;
        try
        {
            var mediaUrns = new List<string>();
            var mediaType = "NONE";
            
            // ... (rest is creating request, which now takes scheduledAt)
            // 1. Upload Media step
            if (_files != null && _files.Any())
            {
                var isVideo = _files.First().ContentType.StartsWith("video/", StringComparison.OrdinalIgnoreCase);
                mediaType = isVideo ? "VIDEO" : "IMAGE";
                int count = 0;
                
                foreach (var file in _files)
                {
                     count++;
                     _uploadProgress = (int)((count / (double)_files.Count) * 50); // First 50%
                     StateHasChanged(); 

                     using var content = new MultipartFormDataContent();
                     using var stream = file.OpenReadStream(maxAllowedSize: 50 * 1024 * 1024); 
                     using var fileContent = new StreamContent(stream);
                     fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(file.ContentType);
                     content.Add(fileContent, "file", file.Name);
                     
                     var uploadReq = new HttpRequestMessage(HttpMethod.Post, "/api/linkedin/upload");
                     uploadReq.Headers.Add("X-LinkedIn-Token", LinkedInState.AccessToken);
                     uploadReq.Content = content;
                     
                     var uploadRes = await Http.SendAsync(uploadReq);
                     if (!uploadRes.IsSuccessStatusCode)
                     {
                         var err = await uploadRes.Content.ReadAsStringAsync();
                         throw new Exception($"Failed to upload media: {err}");
                     }
                     
                     var uploadResult = await uploadRes.Content.ReadFromJsonAsync<LinkedInUploadResponse>();
                     if (uploadResult != null) mediaUrns.Add(uploadResult.AssetUrn);
                }
            }
            
            _uploadProgress = 75;
            StateHasChanged();

            // 2. Post Creation
            var request = new HttpRequestMessage(HttpMethod.Post, "/api/linkedin/post");
            request.Headers.Add("X-LinkedIn-Token", LinkedInState.AccessToken);
            request.Content = JsonContent.Create(new CreateLinkedInPostRequest(_newPostContent, mediaUrns, mediaType, _comments, scheduledAt));

            var response = await Http.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<LinkedInPostCreatedResponse>();
                if (result != null && result.IsScheduled)
                {
                    Snackbar.Add($"Post scheduled for {scheduledAt:g}", Severity.Success);
                }
                else
                {
                    Snackbar.Add("Post created successfully!", Severity.Success);
                }
                
                _newPostContent = string.Empty;
                ClearFiles();
                _comments.Clear();
                _showScheduleOptions = false;
            }
            else
            {
                var errorMsg = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Failed to {(scheduledAt.HasValue ? "schedule" : "create")} post. Status: {response.StatusCode}. {errorMsg}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _posting = false;
            _uploadProgress = 0;
        }
    }
}
