@using GenPosting.Shared.DTOs
@using GenPosting.Web.Services
@using MudBlazor
@inject HttpClient Http

<MudDialog>
    <DialogContent>
        @if (_isLoading)
        {
            <div class="d-flex justify-center pa-4">
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
            </div>
        }
        else if (_insights == null || !_insights.Any())
        {
            <MudAlert Severity="Severity.Info">No insights available for this post (or not supported for this media type).</MudAlert>
        }
        else
        {
            <MudList T="string" Dense="true">
                @foreach (var metric in _insights)
                {
                    <MudListItem>
                        <div class="d-flex justify-space-between align-center">
                            <div>
                                <MudText Typo="Typo.subtitle2">@metric.Title</MudText>
                                <MudText Typo="Typo.caption" Class="grey-text">@metric.Name</MudText>
                            </div>
                            <MudChip T="string" Variant="Variant.Outlined" Color="Color.Success">
                                @(metric.Values.FirstOrDefault()?.Value ?? "N/A")
                            </MudChip>
                        </div>
                    </MudListItem>
                    <MudDivider />
                }
            </MudList>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter] public string MediaId { get; set; } = "";
    [Parameter] public string AccessToken { get; set; } = "";

    private List<InstagramInsightMetric> _insights = new();
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadInsights();
    }

    private async Task LoadInsights()
    {
        try
        {
            var request = new HttpRequestMessage(HttpMethod.Get, $"/api/instagram/media/{MediaId}/insights");
            request.Headers.Add("X-Instagram-Token", AccessToken);
            
            var response = await Http.SendAsync(request);
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<InstagramInsightsResponse>();
                _insights = result?.Data ?? new();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading insights: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void Cancel() => MudDialog.Cancel();
}
